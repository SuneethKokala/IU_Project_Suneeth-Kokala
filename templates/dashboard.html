<!DOCTYPE html>
<html lang="en">
<head>
    <title>Safety Monitoring Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fff;
            color: #333;
            overflow-x: hidden;
        }
        #three-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .container { 
            position: relative; 
            z-index: 1; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .header { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 123, 255, 0.2);
            color: #333; 
            padding: 25px 30px; 
            border-radius: 15px; 
            margin-bottom: 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.1);
        }
        .header h1 { font-size: 2.2em; font-weight: 300; color: #007bff; }
        .logout-btn { 
            background: rgba(0, 123, 255, 0.1); 
            padding: 8px 16px; 
            border-radius: 20px; 
            text-decoration: none; 
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
        }
        .logout-btn:hover { 
            background: rgba(0, 123, 255, 0.2);
            color: #0056b3;
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .stat-card:hover { 
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-5px); 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }
        .stat-icon { font-size: 2.5em; margin-bottom: 15px; }
        .stat-card:nth-child(1) .stat-icon { color: #dc3545; }
        .stat-card:nth-child(2) .stat-icon { color: #28a745; }
        .stat-card:nth-child(3) .stat-icon { color: #ffc107; }
        .stat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 10px; }
        .stat-card:nth-child(1) .stat-number { color: #dc3545; }
        .stat-card:nth-child(2) .stat-number { color: #28a745; }
        .stat-card:nth-child(3) .stat-number { color: #ffc107; }
        .stat-label { color: #666; font-weight: 500; }
        .alert-panel { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .panel-title { font-size: 1.5em; color: #333; font-weight: 600; }
        .export-btn { 
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #28a745; 
            padding: 12px 24px; 
            border-radius: 25px; 
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .export-btn:hover { 
            background: rgba(40, 167, 69, 0.2);
            transform: translateY(-2px); 
        }
        .history { max-height: 500px; overflow-y: auto; }
        .violation { 
            background: rgba(255, 243, 205, 0.8);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 12px; 
            border-left: 4px solid #dc3545;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .violation:hover { 
            transform: translateX(5px);
            background: rgba(255, 243, 205, 0.9);
        }
        .violation.notified { 
            background: rgba(212, 237, 218, 0.8);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-left-color: #28a745; 
        }
        .violation.notified:hover {
            background: rgba(212, 237, 218, 0.9);
        }
        .violation-content { display: flex; justify-content: space-between; align-items: flex-start; }
        .violation-info { flex: 1; }
        .employee-name { font-weight: 600; color: #333; font-size: 1.1em; margin-bottom: 5px; }
        .missing-ppe { 
            color: #dc3545; 
            font-weight: 600; 
            margin-bottom: 8px;
            padding: 5px 10px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 15px;
            display: inline-block;
        }
        .timestamp { color: #666; font-size: 0.9em; }
        .notified-info { 
            color: #28a745; 
            font-size: 0.9em; 
            margin-top: 8px;
            padding: 5px 10px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 15px;
            display: inline-block;
        }
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .checkbox-container:hover { background: rgba(0, 0, 0, 0.1); }
        .checkbox-label { font-size: 0.9em; color: #666; font-weight: 500; }
        .no-violations { 
            text-align: center; 
            padding: 40px; 
            color: #666;
            font-size: 1.1em;
        }
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #666;
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .panel-header { flex-direction: column; gap: 15px; }
            .violation-content { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <canvas id="three-canvas"></canvas>
    
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Safety Monitoring Dashboard</h1>
            <div>
                <span><i class="fas fa-user-tie"></i> Supervisor Panel</span>
                <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-number" id="total-count">0</div>
                <div class="stat-label">Total Violations</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                <div class="stat-number" id="today-count">0</div>
                <div class="stat-label">Today's Violations</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-bell"></i></div>
                <div class="stat-number" id="pending-count">0</div>
                <div class="stat-label">Pending Notifications</div>
            </div>
        </div>

        <div class="alert-panel">
            <div class="panel-header">
                <h2 class="panel-title"><i class="fas fa-clipboard-list"></i> Violation History</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="openCamera()" class="export-btn" style="background: rgba(220, 53, 69, 0.1); border-color: rgba(220, 53, 69, 0.3); color: #dc3545;" id="camera-btn">
                        <i class="fas fa-video"></i> Open Realtime Camera
                    </button>
                    <button onclick="clearData()" class="export-btn" style="background: rgba(108, 117, 125, 0.1); border-color: rgba(108, 117, 125, 0.3); color: #6c757d;">
                        <i class="fas fa-trash"></i> Clear Data
                    </button>
                    <button onclick="refreshData()" class="export-btn" style="background: rgba(0, 123, 255, 0.1); border-color: rgba(0, 123, 255, 0.3); color: #007bff;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button onclick="syncToDatabase()" class="export-btn" style="background: rgba(138, 43, 226, 0.1); border-color: rgba(138, 43, 226, 0.3); color: #8a2be2;">
                        <i class="fas fa-database"></i> Sync to DB
                    </button>
                    <button onclick="viewDatabase()" class="export-btn" style="background: rgba(75, 192, 192, 0.1); border-color: rgba(75, 192, 192, 0.3); color: #4bc0c0;">
                        <i class="fas fa-eye"></i> View DB Data
                    </button>
                    <button onclick="exportExcel()" class="export-btn">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                </div>
            </div>
            <div id="violation-history" class="history">
                <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Three.js raycaster sprite system
        let renderer, scene, camera, group;
        let selectedObject = null;
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        function initThree() {
            // Init renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setAnimationLoop(animate);

            // Init scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            group = new THREE.Group();
            scene.add(group);

            // Init camera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.set(15, 15, 15);
            camera.lookAt(scene.position);

            // Add sprites
            const sprite1 = new THREE.Sprite(new THREE.SpriteMaterial({ color: '#69f' }));
            sprite1.position.set(6, 5, 5);
            sprite1.scale.set(2, 5, 1);
            group.add(sprite1);

            const sprite2 = new THREE.Sprite(new THREE.SpriteMaterial({ color: '#69f', sizeAttenuation: false }));
            sprite2.material.rotation = Math.PI / 3 * 4;
            sprite2.position.set(8, -2, 2);
            sprite2.center.set(0.5, 0);
            sprite2.scale.set(0.1, 0.5, 0.1);
            group.add(sprite2);

            const group2 = new THREE.Object3D();
            group2.scale.set(1, 2, 1);
            group2.position.set(-5, 0, 0);
            group2.rotation.set(Math.PI / 2, 0, 0);
            group.add(group2);

            const sprite3 = new THREE.Sprite(new THREE.SpriteMaterial({ color: '#69f' }));
            sprite3.position.set(0, 2, 5);
            sprite3.scale.set(10, 2, 3);
            sprite3.center.set(-0.1, 0);
            sprite3.material.rotation = Math.PI / 3;
            group2.add(sprite3);

            // Add more decorative sprites
            for (let i = 0; i < 20; i++) {
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                    color: new THREE.Color().setHSL(Math.random(), 0.7, 0.6),
                    transparent: true,
                    opacity: 0.6
                }));
                sprite.position.set(
                    (Math.random() - 0.5) * 30,
                    (Math.random() - 0.5) * 30,
                    (Math.random() - 0.5) * 30
                );
                sprite.scale.set(Math.random() * 2 + 0.5, Math.random() * 2 + 0.5, 1);
                group.add(sprite);
            }

            window.addEventListener('resize', onWindowResize);
            document.addEventListener('pointermove', onPointerMove);
        }

        function animate() {
            // Rotate the group slowly
            group.rotation.y += 0.005;
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onPointerMove(event) {
            if (selectedObject) {
                selectedObject.material.color.set('#69f');
                selectedObject = null;
            }

            pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObject(group, true);

            if (intersects.length > 0) {
                const res = intersects.filter(function (res) {
                    return res && res.object;
                })[0];

                if (res && res.object) {
                    selectedObject = res.object;
                    selectedObject.material.color.set('#f00');
                }
            }
        }

        // Dashboard functions
        function loadViolations() {
            fetch('/api/violations')
                .then(response => response.json())
                .then(data => {
                    updateViolationHistory(data.history);
                    updateStats(data.history);
                })
                .catch(error => console.error('Error:', error));
        }

        function updateViolationHistory(history) {
            const container = document.getElementById('violation-history');
            if (history.length === 0) {
                container.innerHTML = '<div class="no-violations"><i class="fas fa-check-circle" style="font-size: 3em; color: #28a745; margin-bottom: 15px;"></i><br>No violations recorded</div>';
                return;
            }

            container.innerHTML = history.reverse().map((v, index) => {
                const isNotified = v.notified || false;
                const notifiedAt = v.notified_at ? new Date(v.notified_at).toLocaleString() : '';
                const originalIndex = history.length - 1 - index;
                
                return `
                    <div class="violation ${isNotified ? 'notified' : ''}">
                        <div class="violation-content">
                            <div class="violation-info">
                                <div class="employee-name"><i class="fas fa-user"></i> ${v.employee_name} (${v.employee_id})</div>
                                <div class="missing-ppe"><i class="fas fa-hard-hat"></i> Missing: ${v.missing_ppe.join(', ')}</div>
                                <div class="timestamp"><i class="fas fa-clock"></i> ${new Date(v.timestamp).toLocaleString()}</div>
                                ${isNotified ? `<div class="notified-info"><i class="fas fa-check"></i> Notified at: ${notifiedAt}</div>` : ''}
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" ${isNotified ? 'checked disabled' : ''} 
                                       onchange="markAsNotified(${originalIndex}, this)">
                                <span class="checkbox-label">${isNotified ? 'Notified' : 'Mark as Notified'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats(history) {
            document.getElementById('total-count').textContent = history.length;
            
            const today = new Date().toDateString();
            const todayViolations = history.filter(v => 
                new Date(v.timestamp).toDateString() === today
            );
            document.getElementById('today-count').textContent = todayViolations.length;
            
            const pendingNotifications = history.filter(v => !v.notified).length;
            document.getElementById('pending-count').textContent = pendingNotifications;
        }

        function markAsNotified(violationIndex, checkbox) {
            fetch('/api/mark_notified', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: violationIndex })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checkbox.disabled = true;
                    checkbox.nextElementSibling.textContent = 'Notified';
                    loadViolations();
                } else {
                    alert('Failed to mark as notified: ' + data.error);
                    checkbox.checked = false;
                }
            })
            .catch(error => {
                alert('Error marking as notified: ' + error.message);
                checkbox.checked = false;
            });
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all violation data? This action cannot be undone.')) {
                const clearBtn = event.target;
                clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
                clearBtn.disabled = true;
                
                fetch('/api/clear_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadViolations();
                        clearBtn.innerHTML = '<i class="fas fa-trash"></i> Clear Data';
                    } else {
                        throw new Error(data.error || 'Failed to clear data');
                    }
                })
                .catch(error => {
                    alert('Failed to clear data: ' + error.message);
                    clearBtn.innerHTML = '<i class="fas fa-trash"></i> Clear Data';
                })
                .finally(() => {
                    clearBtn.disabled = false;
                });
            }
        }

        function refreshData() {
            const refreshBtn = event.target;
            const icon = refreshBtn.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            // Load fresh data
            loadViolations();
            
            // Remove spinning after 1 second
            setTimeout(() => {
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            }, 1000);
        }

        let cameraRunning = false;
        
        function openCamera() {
            const cameraBtn = event.target;
            
            if (!cameraRunning) {
                // Start camera
                cameraBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
                cameraBtn.disabled = true;
                
                fetch('/api/start_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cameraBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Detection';
                        cameraBtn.style.background = 'rgba(255, 193, 7, 0.1)';
                        cameraBtn.style.borderColor = 'rgba(255, 193, 7, 0.3)';
                        cameraBtn.style.color = '#ffc107';
                        cameraBtn.disabled = false;
                        cameraRunning = true;
                    } else {
                        throw new Error(data.error || 'Failed to start camera');
                    }
                })
                .catch(error => {
                    alert('Failed to start camera: ' + error.message);
                    cameraBtn.innerHTML = '<i class="fas fa-video"></i> Open Realtime Camera';
                    cameraBtn.disabled = false;
                });
            } else {
                // Stop camera
                cameraBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';
                cameraBtn.disabled = true;
                
                fetch('/api/stop_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cameraBtn.innerHTML = '<i class="fas fa-video"></i> Open Realtime Camera';
                        cameraBtn.style.background = 'rgba(220, 53, 69, 0.1)';
                        cameraBtn.style.borderColor = 'rgba(220, 53, 69, 0.3)';
                        cameraBtn.style.color = '#dc3545';
                        cameraBtn.disabled = false;
                        cameraRunning = false;
                    } else {
                        throw new Error(data.error || 'Failed to stop camera');
                    }
                })
                .catch(error => {
                    alert('Failed to stop camera: ' + error.message);
                    cameraBtn.disabled = false;
                });
            }
        }

        function syncToDatabase() {
            const syncBtn = event.target;
            const icon = syncBtn.querySelector('i');
            
            icon.classList.add('fa-spin');
            syncBtn.disabled = true;
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            
            fetch('/api/sync_to_database', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                } else {
                    alert('❌ Sync failed: ' + data.error);
                }
            })
            .catch(error => {
                alert('❌ Sync error: ' + error.message);
            })
            .finally(() => {
                syncBtn.innerHTML = '<i class="fas fa-database"></i> Sync to DB';
                syncBtn.disabled = false;
            });
        }

        function viewDatabase() {
            const viewBtn = event.target;
            viewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            viewBtn.disabled = true;
            
            fetch('/api/view_database')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create modal to show database data
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                            align-items: center; justify-content: center;
                        `;
                        
                        const content = document.createElement('div');
                        content.style.cssText = `
                            background: white; padding: 30px; border-radius: 15px;
                            max-width: 90%; max-height: 80%; overflow: auto;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        `;
                        
                        let tableHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2><i class="fas fa-database"></i> Database Records (${data.data.length})</h2>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Timestamp</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Employee</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Missing PPE</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Location</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Notified</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.data.forEach(row => {
                            const missingPpe = typeof row.missing_ppe === 'string' ? 
                                JSON.parse(row.missing_ppe) : row.missing_ppe;
                            tableHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${row.id}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${new Date(row.timestamp).toLocaleString()}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${row.employee_name} (${row.employee_id})</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; color: #dc3545;">${missingPpe.join(', ')}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${row.location}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">
                                        <span style="color: ${row.notified ? '#28a745' : '#dc3545'};">
                                            ${row.notified ? '✅ Yes' : '❌ No'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table></div>';
                        content.innerHTML = tableHTML;
                        modal.appendChild(content);
                        document.body.appendChild(modal);
                    } else {
                        alert('❌ Failed to load database data: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('❌ Error loading database data: ' + error.message);
                })
                .finally(() => {
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i> View DB Data';
                    viewBtn.disabled = false;
                });
        }

        function exportExcel() {
            fetch('/api/export_excel')
                .then(response => {
                    if (response.ok) return response.blob();
                    throw new Error('Export failed');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `PPE_Violations_Report_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => alert('Failed to export Excel file: ' + error.message));
        }

        // Initialize
        initThree();
        loadViolations();
        setInterval(loadViolations, 5000);
    </script>
</body>
</html>